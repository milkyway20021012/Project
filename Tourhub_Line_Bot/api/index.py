from flask import Flask, request, abort
import os
import logging
import requests
from bs4 import BeautifulSoup
import re
import json
import time

# Â∞éÂÖ•ÈÖçÁΩÆÊñá‰ª∂
from api.config import (
    MESSAGE_TEMPLATES, 
    LEADERBOARD_DATA, 
    KEYWORD_MAPPINGS, 
    MEETING_LOCATIONS, 
    TIME_PATTERNS, 
    MEETING_TIME_PATTERN
)

# LINE Bot imports
from linebot.v3 import WebhookHandler
from linebot.v3.exceptions import InvalidSignatureError
from linebot.v3.messaging import (
    Configuration,
    ApiClient,
    MessagingApi,
    ReplyMessageRequest,
    PushMessageRequest,
    TextMessage,
    FlexMessage,
    FlexContainer
)
from linebot.v3.webhooks import MessageEvent, TextMessageContent, PostbackEvent

# Ë®≠ÂÆöÊó•Ë™å
logging.basicConfig(level=logging.INFO)
logger = logging.getLogger(__name__)

# Âª∫Á´ã Flask app
app = Flask(__name__)

def create_flex_message(template_type, **kwargs):
    """
    ÂãïÊÖãÂâµÂª∫ Flex Message
    template_type: 'reminder', 'feature', 'leaderboard', 'meeting_success', 'help', 'trip_list', 'trip_detail'
    """
    if template_type == "reminder":
        reminder_type = kwargs.get('reminder_type')
        meeting_time = kwargs.get('meeting_time')
        meeting_location = kwargs.get('meeting_location')
        
        template = MESSAGE_TEMPLATES["reminder"][reminder_type]
        
        return {
            "type": "bubble",
            "size": "kilo",
            "header": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": template["title"],
                        "weight": "bold",
                        "size": "lg",
                        "color": "#ffffff",
                        "align": "center"
                    }
                ],
                "backgroundColor": template["color"],
                "paddingAll": "20px"
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": f"{template['emoji']} {template['message']}\nüìç ÈõÜÂêàÂú∞ÈªûÔºö{meeting_location}\n‚è∞ ÈõÜÂêàÊôÇÈñìÔºö{meeting_time}",
                        "size": "sm",
                        "color": "#555555",
                        "wrap": True,
                        "margin": "md"
                    }
                ],
                "paddingAll": "20px"
            },
            "footer": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "button",
                        "action": {
                            "type": "uri",
                            "label": "Êü•ÁúãÂú∞Âúñ",
                            "uri": f"https://maps.google.com/maps?q={meeting_location}"
                        },
                        "style": "primary",
                        "color": template["color"],
                        "height": "sm"
                    }
                ],
                "paddingAll": "20px"
            }
        }
    
    elif template_type == "feature":
        feature_name = kwargs.get('feature_name')
        template = MESSAGE_TEMPLATES["features"][feature_name]
        
        return {
            "type": "bubble",
            "size": "kilo",
            "header": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": template["title"],
                        "weight": "bold",
                        "size": "lg",
                        "color": "#ffffff",
                        "align": "center"
                    }
                ],
                "backgroundColor": template["color"],
                "paddingAll": "20px"
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": template["description"],
                        "size": "md",
                        "color": "#555555",
                        "align": "center",
                        "margin": "md"
                    },
                    {
                        "type": "text",
                        "text": template["sub_description"],
                        "size": "sm",
                        "color": "#888888",
                        "align": "center",
                        "margin": "sm"
                    }
                ],
                "paddingAll": "20px"
            },
            "footer": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "button",
                        "action": {
                            "type": "uri",
                            "label": template["button_text"],
                            "uri": template["url"]
                        },
                        "style": "primary",
                        "color": template["color"],
                        "height": "sm"
                    }
                ],
                "paddingAll": "20px"
            }
        }
    
    elif template_type == "leaderboard":
        rank = kwargs.get('rank')
        # ‰ΩøÁî®Ë≥áÊñôÂ∫´ÁöÑÊéíË°åÊ¶úË≥áÊñô
        leaderboard_data = get_leaderboard_data()
        data = leaderboard_data.get(rank, LEADERBOARD_DATA.get(rank, {}))
        
        return {
            "type": "bubble",
            "size": "giga",
            "header": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": data["title"],
                        "weight": "bold",
                        "size": "lg",
                        "color": "#ffffff",
                        "align": "center"
                    }
                ],
                "backgroundColor": data["color"],
                "paddingAll": "20px"
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "box",
                        "layout": "horizontal",
                        "contents": [
                            {"type": "text", "text": "üìç", "size": "md", "flex": 0},
                            {"type": "text", "text": f"ÁõÆÁöÑÂú∞Ôºö{data['destination']}", "size": "sm", "color": "#555555", "flex": 1, "marginStart": "md"}
                        ],
                        "marginBottom": "sm"
                    },
                    {
                        "type": "box",
                        "layout": "horizontal",
                        "contents": [
                            {"type": "text", "text": "üìÖ", "size": "md", "flex": 0},
                            {"type": "text", "text": f"Ë°åÁ®ãÂ§©Êï∏Ôºö{data['duration']}", "size": "sm", "color": "#555555", "flex": 1, "marginStart": "md"}
                        ],
                        "marginBottom": "sm"
                    },
                    {
                        "type": "box",
                        "layout": "horizontal",
                        "contents": [
                            {"type": "text", "text": "üë•", "size": "md", "flex": 0},
                            {"type": "text", "text": f"ÂèÉËàá‰∫∫Êï∏Ôºö{data['participants']}", "size": "sm", "color": "#555555", "flex": 1, "marginStart": "md"}
                        ],
                        "marginBottom": "sm"
                    },
                    {
                        "type": "box",
                        "layout": "horizontal",
                        "contents": [
                            {"type": "text", "text": "üí°", "size": "md", "flex": 0},
                            {"type": "text", "text": f"ÁâπËâ≤Ôºö{data['feature']}", "size": "sm", "color": "#555555", "flex": 1, "marginStart": "md"}
                        ],
                        "marginBottom": "md"
                    },
                    {"type": "separator", "margin": "md"},
                    {"type": "text", "text": "üìã Ë©≥Á¥∞Ë°åÁ®ã", "weight": "bold", "size": "md", "color": "#555555", "margin": "md"},
                    {"type": "text", "text": data["itinerary"], "size": "xs", "color": "#888888", "wrap": True, "margin": "sm"}
                ],
                "paddingAll": "20px"
            },
            "footer": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "button",
                        "action": {
                            "type": "uri",
                            "label": "Êü•ÁúãÂÆåÊï¥ÊéíË°åÊ¶ú",
                            "uri": "https://tourhub-ashy.vercel.app/?state=n6sFheuU2eAl&liffClientId=2007678368&liffRedirectUri=https%3A%2F%2Ftourhub-ashy.vercel.app%2F&code=DJhtwXyqmCdyhnBlGs3s"
                        },
                        "style": "primary",
                        "color": data["color"],
                        "height": "sm"
                    }
                ],
                "paddingAll": "20px"
            }
        }
    
    elif template_type == "meeting_success":
        meeting_time = kwargs.get('meeting_time')
        meeting_location = kwargs.get('meeting_location')
        is_success = kwargs.get('is_success', False)
        template = MESSAGE_TEMPLATES["meeting_success"]
        
        status_text = template["status_success"] if is_success else template["status_local"]
        status_color = template["status_success_color"] if is_success else template["status_local_color"]
        
        return {
            "type": "bubble",
            "size": "kilo",
            "header": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": template["title"],
                        "weight": "bold",
                        "size": "lg",
                        "color": "#ffffff",
                        "align": "center"
                    }
                ],
                "backgroundColor": template["color"],
                "paddingAll": "20px"
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "box",
                        "layout": "horizontal",
                        "contents": [
                            {"type": "text", "text": "‚è∞", "size": "md", "flex": 0},
                            {"type": "text", "text": f"ÈõÜÂêàÊôÇÈñìÔºö{meeting_time}", "size": "sm", "color": "#555555", "flex": 1, "marginStart": "md"}
                        ],
                        "marginBottom": "sm"
                    },
                    {
                        "type": "box",
                        "layout": "horizontal",
                        "contents": [
                            {"type": "text", "text": "üìç", "size": "md", "flex": 0},
                            {"type": "text", "text": f"ÈõÜÂêàÂú∞ÈªûÔºö{meeting_location}", "size": "sm", "color": "#555555", "flex": 1, "marginStart": "md"}
                        ],
                        "marginBottom": "sm"
                    },
                    {
                        "type": "box",
                        "layout": "horizontal",
                        "contents": [
                            {"type": "text", "text": "‚úÖ", "size": "md", "flex": 0},
                            {"type": "text", "text": f"ÁãÄÊÖãÔºö{status_text}", "size": "sm", "color": status_color, "flex": 1, "marginStart": "md"}
                        ],
                        "marginBottom": "md"
                    },
                    {"type": "separator", "margin": "md"},
                    {"type": "text", "text": "üéâ ÈõÜÂêàË®≠ÂÆöÂÆåÊàêÔºÅ", "weight": "bold", "size": "sm", "color": "#27AE60", "align": "center", "margin": "md"},
                    {"type": "text", "text": "Â∑≤ÊàêÂäüË®≠ÂÆöÈõÜÂêàÊôÇÈñìÂíåÂú∞ÈªûÔºåÊâÄÊúâÊàêÂì°ÈÉΩÊúÉÊî∂Âà∞ÈÄöÁü•", "size": "xs", "color": "#888888", "align": "center", "wrap": True, "margin": "sm"},
                    {"type": "separator", "margin": "md"},
                    {"type": "text", "text": template["reminder_info"], "weight": "bold", "size": "sm", "color": template["color"], "align": "center", "margin": "md"},
                    {"type": "text", "text": template["reminder_details"], "size": "xs", "color": "#888888", "align": "center", "wrap": True, "margin": "sm"}
                ],
                "paddingAll": "20px"
            },
            "footer": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "button",
                        "action": {
                            "type": "uri",
                            "label": "Êü•Áúã TourClock",
                            "uri": "https://tourclock.vercel.app/"
                        },
                        "style": "primary",
                        "color": template["color"],
                        "height": "sm"
                    },
                    {
                        "type": "button",
                        "action": {
                            "type": "uri",
                            "label": "ÂàÜ‰∫´ÈõÜÂêàË≥áË®ä",
                            "uri": f"https://line.me/R/msg/text/?‚è∞ ÈõÜÂêàÊôÇÈñìÔºö{meeting_time}%0Aüìç ÈõÜÂêàÂú∞ÈªûÔºö{meeting_location}%0A%0Aüåê Êü•ÁúãË©≥ÊÉÖÔºöhttps://tourclock.vercel.app/"
                        },
                        "style": "secondary",
                        "color": template["color"],
                        "height": "sm",
                        "marginTop": "sm"
                    }
                ],
                "paddingAll": "20px"
            }
        }
    
    elif template_type == "help":
        template = MESSAGE_TEMPLATES["help"]
        
        feature_contents = []
        for feature in template["features"]:
            feature_contents.extend([
                {
                    "type": "box",
                    "layout": "horizontal",
                    "contents": [
                        {"type": "text", "text": feature["emoji"], "size": "lg", "flex": 0},
                        {
                            "type": "box",
                            "layout": "vertical",
                            "contents": [
                                {"type": "text", "text": feature["name"], "weight": "bold", "size": "sm", "color": "#555555"},
                                {"type": "text", "text": feature["description"], "size": "xs", "color": "#888888", "wrap": True}
                            ],
                            "flex": 1,
                            "marginStart": "md"
                        }
                    ],
                    "marginBottom": "md"
                }
            ])
        
        return {
            "type": "bubble",
            "size": "giga",
            "header": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": template["title"],
                        "weight": "bold",
                        "size": "lg",
                        "color": "#ffffff",
                        "align": "center"
                    }
                ],
                "backgroundColor": template["color"],
                "paddingAll": "20px"
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": feature_contents,
                "paddingAll": "20px"
            }
        }
    
    elif template_type == "trip_list":
        location = kwargs.get('location')
        trips = kwargs.get('trips')
        
        trip_contents = []
        for i, trip in enumerate(trips[:5]):  # ÊúÄÂ§öÈ°ØÁ§∫5Ê¢ùË°åÁ®ã
            trip_contents.append({
                "type": "box",
                "layout": "horizontal",
                "contents": [
                    {
                        "type": "box",
                        "layout": "vertical",
                        "contents": [
                            {
                                "type": "text",
                                "text": trip["title"],
                                "weight": "bold",
                                "size": "sm",
                                "color": "#555555"
                            },
                            {
                                "type": "text",
                                "text": f"‚è∞ {trip['duration']} | ‚≠ê {trip['rating']}",
                                "size": "xs",
                                "color": "#888888",
                                "marginTop": "sm"
                            },
                            {
                                "type": "text",
                                "text": f"üìç {trip['highlights']}",
                                "size": "xs",
                                "color": "#888888",
                                "wrap": True,
                                "marginTop": "sm"
                            }
                        ],
                        "flex": 1
                    },
                    {
                        "type": "button",
                        "action": {
                            "type": "postback",
                            "label": "Êü•ÁúãË©≥ÊÉÖ",
                            "data": f"trip_detail:{trip['id']}"
                        },
                        "style": "primary",
                        "color": "#9B59B6",
                        "height": "sm",
                        "marginStart": "md"
                    }
                ],
                "marginBottom": "md",
                "paddingAll": "sm",
                "backgroundColor": "#f8f9fa",
                "cornerRadius": "md"
            })
        
        return {
            "type": "bubble",
            "size": "giga",
            "header": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": f"üó∫Ô∏è {location} Ë°åÁ®ãÊé®Ëñ¶",
                        "weight": "bold",
                        "size": "lg",
                        "color": "#ffffff",
                        "align": "center"
                    }
                ],
                "backgroundColor": "#9B59B6",
                "paddingAll": "20px"
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": trip_contents,
                "paddingAll": "20px"
            }
        }
    
    elif template_type == "trip_detail":
        trip = kwargs.get('trip')
        
        itinerary_contents = []
        for day_key, day_itinerary in trip["itinerary"].items():
            itinerary_contents.append({
                "type": "box",
                "layout": "horizontal",
                "contents": [
                    {
                        "type": "text",
                        "text": day_key.replace("day", "Day "),
                        "weight": "bold",
                        "size": "sm",
                        "color": "#9B59B6",
                        "flex": 0
                    },
                    {
                        "type": "text",
                        "text": day_itinerary,
                        "size": "sm",
                        "color": "#555555",
                        "flex": 1,
                        "wrap": True,
                        "marginStart": "md"
                    }
                ],
                "marginBottom": "sm"
            })
        
        return {
            "type": "bubble",
            "size": "giga",
            "header": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "text",
                        "text": trip["title"],
                        "weight": "bold",
                        "size": "lg",
                        "color": "#ffffff",
                        "align": "center"
                    }
                ],
                "backgroundColor": "#9B59B6",
                "paddingAll": "20px"
            },
            "body": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "box",
                        "layout": "horizontal",
                        "contents": [
                            {"type": "text", "text": "‚è∞", "size": "md", "flex": 0},
                            {"type": "text", "text": f"Ë°åÁ®ãÂ§©Êï∏Ôºö{trip['duration']}", "size": "sm", "color": "#555555", "flex": 1, "marginStart": "md"}
                        ],
                        "marginBottom": "sm"
                    },

                    {
                        "type": "box",
                        "layout": "horizontal",
                        "contents": [
                            {"type": "text", "text": "‚≠ê", "size": "md", "flex": 0},
                            {"type": "text", "text": f"Ë©ïÂàÜÔºö{trip['rating']}", "size": "sm", "color": "#555555", "flex": 1, "marginStart": "md"}
                        ],
                        "marginBottom": "sm"
                    },
                    {
                        "type": "box",
                        "layout": "horizontal",
                        "contents": [
                            {"type": "text", "text": "üìç", "size": "md", "flex": 0},
                            {"type": "text", "text": f"‰∫ÆÈªûÔºö{trip['highlights']}", "size": "sm", "color": "#555555", "flex": 1, "marginStart": "md"}
                        ],
                        "marginBottom": "md"
                    },
                    {"type": "separator", "margin": "md"},
                    {"type": "text", "text": "üìã Ë©≥Á¥∞Ë°åÁ®ã", "weight": "bold", "size": "md", "color": "#555555", "margin": "md"},
                    *itinerary_contents
                ],
                "paddingAll": "20px"
            },
            "footer": {
                "type": "box",
                "layout": "vertical",
                "contents": [
                    {
                        "type": "button",
                        "action": {
                            "type": "uri",
                            "label": "ÈñãÂßãË¶èÂäÉË°åÁ®ã",
                            "uri": "https://tripfrontend.vercel.app/linetrip"
                        },
                        "style": "primary",
                        "color": "#9B59B6",
                        "height": "sm"
                    }
                ],
                "paddingAll": "20px"
            }
        }

def get_message_template(user_message):
    """
    Ê†πÊìöÁî®Êà∂Ê∂àÊÅØÁç≤ÂèñÂ∞çÊáâÁöÑÊ®°ÊùøÈÖçÁΩÆ
    ÊîØÊåÅÂÆåÂÖ®ÂåπÈÖçÂíåÈÉ®ÂàÜÂåπÈÖçÔºåÂÑ™ÂÖàÂåπÈÖçÊõ¥ÂÖ∑È´îÁöÑÈóúÈçµÂ≠ó
    """
    # È¶ñÂÖàÂòóË©¶ÂÆåÂÖ®ÂåπÈÖç
    for key, mapping in KEYWORD_MAPPINGS.items():
        if user_message in mapping["keywords"]:
            return mapping
    
    # Â¶ÇÊûúÂÆåÂÖ®ÂåπÈÖçÂ§±ÊïóÔºåÂòóË©¶ÈÉ®ÂàÜÂåπÈÖç
    # ÂÑ™ÂÖàÂåπÈÖçÊõ¥ÂÖ∑È´îÁöÑÈóúÈçµÂ≠óÔºàÂ¶Ç"Á¨¨‰∏ÄÂêç"ÂÑ™ÂÖàÊñº"ÊéíË°åÊ¶ú"Ôºâ
    best_match = None
    best_keyword_length = 0
    
    for key, mapping in KEYWORD_MAPPINGS.items():
        for keyword in mapping["keywords"]:
            if keyword in user_message:
                # ÈÅ∏ÊìáÊúÄÈï∑ÁöÑÈóúÈçµÂ≠óÂåπÈÖçÔºàÊõ¥ÂÖ∑È´îÔºâ
                if len(keyword) > best_keyword_length:
                    best_match = mapping
                    best_keyword_length = len(keyword)
    
    return best_match

def parse_time(user_message):
    """Ëß£ÊûêÂêÑÁ®ÆÊôÇÈñìÊ†ºÂºè"""
    # Ê®ôÊ∫ñÊôÇÈñìÊ†ºÂºè 14:30
    time_match = re.search(TIME_PATTERNS["standard"], user_message)
    if time_match:
        return time_match.group(1)
    
    # ‰∏≠ÊñáÊôÇÈñìÊ†ºÂºè 2Èªû30ÂàÜ
    chinese_time = re.search(TIME_PATTERNS["chinese"], user_message)
    if chinese_time:
        hour = chinese_time.group(1)
        minute = chinese_time.group(2)
        return f"{hour.zfill(2)}:{minute.zfill(2)}"
    
    # Á∞°Âåñ‰∏≠ÊñáÊôÇÈñìÊ†ºÂºè 2Èªû
    simple_chinese_time = re.search(TIME_PATTERNS["simple_chinese"], user_message)
    if simple_chinese_time:
        hour = simple_chinese_time.group(1)
        return f"{hour.zfill(2)}:00"
    
    # ËôïÁêÜ‰∏äÂçà/‰∏ãÂçà/Êôö‰∏ä/ÂáåÊô®
    am_pm_match = re.search(TIME_PATTERNS["am_pm"], user_message)
    if am_pm_match:
        period = am_pm_match.group(1)
        hour = int(am_pm_match.group(2))
        minute = am_pm_match.group(3) if am_pm_match.group(3) else "00"
        
        # ËΩâÊèõÁÇ∫24Â∞èÊôÇÂà∂
        if period == "‰∏ãÂçà" and hour != 12:
            hour += 12
        elif period == "Êôö‰∏ä" and hour != 12:
            hour += 12
        elif period == "ÂáåÊô®" and hour == 12:
            hour = 0
        
        return f"{hour:02d}:{minute.zfill(2)}"
    
    return None

def parse_location(user_message):
    """Ëß£ÊûêÈõÜÂêàÂú∞Èªû"""
    for location in MEETING_LOCATIONS:
        if location in user_message:
            return location
    return None

def find_location_trips(user_message):
    """Êü•ÊâæÂú∞ÂçÄÁõ∏ÈóúË°åÁ®ã"""
    from api.config import TRIP_DATABASE
    
    for location in TRIP_DATABASE.keys():
        if location in user_message:
            return location, TRIP_DATABASE[location]
    return None, None

def find_trip_by_id(trip_id):
    """Ê†πÊìöIDÊü•ÊâæË°åÁ®ã"""
    from api.config import TRIP_DATABASE
    
    for location_trips in TRIP_DATABASE.values():
        for trip in location_trips:
            if trip["id"] == trip_id:
                return trip
    return None

# ÊéíË°åÊ¶úË≥áÊñôÁ∑©Â≠ò
_leaderboard_cache = None
_cache_timestamp = 0
CACHE_DURATION = 300  # 5ÂàÜÈêòÁ∑©Â≠ò

def get_leaderboard_data():
    """ÂæûË≥áÊñôÂ∫´Áç≤ÂèñÊéíË°åÊ¶úË≥áÊñô"""
    global _leaderboard_cache, _cache_timestamp
    
    # Ê™¢Êü•Á∑©Â≠òÊòØÂê¶ÊúâÊïà
    current_time = time.time()
    if _leaderboard_cache and (current_time - _cache_timestamp) < CACHE_DURATION:
        logger.info("‰ΩøÁî®Á∑©Â≠òÁöÑÊéíË°åÊ¶úË≥áÊñô")
        return _leaderboard_cache
    
    try:
        # ÂæûË≥áÊñôÂ∫´Áç≤ÂèñÊéíË°åÊ¶úË≥áÊñô
        from api.database_utils import get_leaderboard_from_database
        leaderboard_data = get_leaderboard_from_database()
        
        if leaderboard_data:
            # Êõ¥Êñ∞Á∑©Â≠ò
            _leaderboard_cache = leaderboard_data
            _cache_timestamp = current_time
            
            logger.info("ÊàêÂäüÂæûË≥áÊñôÂ∫´Áç≤ÂèñÊéíË°åÊ¶úË≥áÊñô‰∏¶Êõ¥Êñ∞Á∑©Â≠ò")
            return leaderboard_data
        else:
            logger.warning("Ë≥áÊñôÂ∫´‰∏≠Ê≤íÊúâÊéíË°åÊ¶úË≥áÊñôÔºå‰ΩøÁî®È†êË®≠Ë≥áÊñô")
            from api.config import LEADERBOARD_DATA
            return LEADERBOARD_DATA
        
    except Exception as e:
        logger.error(f"ÂæûË≥áÊñôÂ∫´Áç≤ÂèñÊéíË°åÊ¶úË≥áÊñôÂ§±Êïó: {str(e)}")
        # Â¶ÇÊûúË≥áÊñôÂ∫´Áç≤ÂèñÂ§±ÊïóÔºåËøîÂõûÈ†êË®≠Ë≥áÊñô
        from api.config import LEADERBOARD_DATA
        return LEADERBOARD_DATA

# ÊèêÈÜíËôïÁêÜÂáΩÊï∏
def send_reminder_message(user_id, meeting_time, meeting_location, reminder_type):
    """
    ÁôºÈÄÅÊèêÈÜíË®äÊÅØÁµ¶Áî®Êà∂
    reminder_type: '10_min_before', '5_min_before', 'on_time'
    """
    try:
        # ‰ΩøÁî®ÂãïÊÖãÊ®°ÊùøÂâµÂª∫ Flex Message
        flex_message = create_flex_message(
            "reminder",
            reminder_type=reminder_type,
            meeting_time=meeting_time,
            meeting_location=meeting_location
        )
        
        with ApiClient(configuration) as api_client:
            line_bot_api = MessagingApi(api_client)
            line_bot_api.push_message_with_http_info(
                PushMessageRequest(
                    to=user_id,
                    messages=[FlexMessage(alt_text="ÈõÜÂêàÊèêÈÜí", contents=FlexContainer.from_dict(flex_message))]
                )
            )
            
        logger.info(f"Â∑≤ÁôºÈÄÅ {reminder_type} ÊèêÈÜíÁµ¶Áî®Êà∂ {user_id}")
        
    except Exception as e:
        logger.error(f"ÁôºÈÄÅÊèêÈÜíË®äÊÅØÂ§±Êïó: {str(e)}")

# Áí∞Â¢ÉËÆäÊï∏Ê™¢Êü•
CHANNEL_ACCESS_TOKEN = os.environ.get('CHANNEL_ACCESS_TOKEN')
CHANNEL_SECRET = os.environ.get('CHANNEL_SECRET')

if CHANNEL_ACCESS_TOKEN and CHANNEL_SECRET:
    configuration = Configuration(access_token=CHANNEL_ACCESS_TOKEN)
    line_handler = WebhookHandler(CHANNEL_SECRET)
    logger.info("LINE Bot Ë®≠ÂÆöÊàêÂäü")
else:
    configuration = None
    line_handler = None
    logger.warning("LINE Bot Áí∞Â¢ÉËÆäÊï∏Êú™Ë®≠ÂÆö")

# ÂÅ•Â∫∑Ê™¢Êü•
@app.route('/')
def health():
    return {
        "status": "running",
        "bot_configured": configuration is not None
    }

# Èô§ÈåØÁ´ØÈªû
@app.route('/debug')
def debug():
    return {
        "has_token": bool(CHANNEL_ACCESS_TOKEN),
        "has_secret": bool(CHANNEL_SECRET),
        "token_length": len(CHANNEL_ACCESS_TOKEN) if CHANNEL_ACCESS_TOKEN else 0
    }

# TourClock ÊèêÈÜíÂõûË™øÁ´ØÈªû
@app.route('/reminder', methods=['POST'])
def reminder_callback():
    try:
        data = request.get_json()
        
        if not data:
            return {"error": "No data received"}, 400
        
        # Ëß£ÊûêÊèêÈÜíË≥áÊñô
        user_id = data.get('user_id')
        meeting_time = data.get('meeting_time')
        meeting_location = data.get('meeting_location')
        reminder_type = data.get('reminder_type')  # '10_min_before', '5_min_before', 'on_time'
        
        if not all([user_id, meeting_time, meeting_location, reminder_type]):
            return {"error": "Missing required fields"}, 400
        
        # ÁôºÈÄÅÊèêÈÜíË®äÊÅØ
        send_reminder_message(user_id, meeting_time, meeting_location, reminder_type)
        
        return {"status": "success", "message": f"Reminder sent: {reminder_type}"}, 200
        
    except Exception as e:
        logger.error(f"ÊèêÈÜíÂõûË™øËôïÁêÜÈåØË™§: {str(e)}")
        return {"error": str(e)}, 500

# LINE Bot callback
@app.route('/callback', methods=['POST'])
def callback():
    if not line_handler:
        return "Bot not configured", 500
    
    try:
        signature = request.headers.get('X-Line-Signature')
        if not signature:
            abort(400)
        
        body = request.get_data(as_text=True)
        line_handler.handle(body, signature)
        return 'OK'
        
    except InvalidSignatureError:
        abort(400)
    except Exception as e:
        logger.error(f"Error: {str(e)}")
        return "Internal error", 500

# Ë®äÊÅØËôïÁêÜ
if line_handler:
    @line_handler.add(MessageEvent, message=TextMessageContent)
    def handle_message(event):
        try:
            user_message = event.message.text
            
            # ÂÑ™ÂÖàÊ™¢Êü•ÊòØÂê¶ÂåÖÂê´ÊôÇÈñìÂú∞ÈªûÁöÑÈõÜÂêàË®≠ÂÆö
            if re.search(MEETING_TIME_PATTERN, user_message):
                # Ëß£ÊûêÈõÜÂêàÊôÇÈñìÂíåÂú∞Èªû
                meeting_time = parse_time(user_message)
                meeting_location = parse_location(user_message)
                
                if meeting_time and meeting_location:
                    
                    try:
                        # Âêë TourClock ÁôºÈÄÅÈõÜÂêàË®≠ÂÆöË´ãÊ±Ç
                        tourclock_url = "https://tourclock.vercel.app/"
                        tourclock_data = {
                            "time": meeting_time,
                            "location": meeting_location,
                            "action": "create_meeting",
                            "user_id": event.source.user_id,  # Ê∑ªÂä†Áî®Êà∂ID
                            "reminders": {
                                "10_min_before": True,
                                "5_min_before": True,
                                "on_time": True
                            },
                            "callback_url": "https://your-vercel-app.vercel.app/reminder"  # ÊèêÈÜíÂõûË™øURL
                        }
                        
                        # ÁôºÈÄÅ POST Ë´ãÊ±ÇÂà∞ TourClock
                        response = requests.post(tourclock_url, json=tourclock_data, timeout=10)
                        
                        if response.status_code == 200:
                            # ÊàêÂäüË®≠ÂÆöÈõÜÂêà
                            flex_message = create_flex_message(
                                "meeting_success",
                                meeting_time=meeting_time,
                                meeting_location=meeting_location,
                                is_success=True
                            )
                        else:
                            # TourClock Ë®≠ÂÆöÂ§±ÊïóÔºå‰ΩÜ‰ªçÈ°ØÁ§∫Êú¨Âú∞Ë®≠ÂÆö
                            flex_message = create_flex_message(
                                "meeting_success",
                                meeting_time=meeting_time,
                                meeting_location=meeting_location,
                                is_success=False
                            )
                        
                        with ApiClient(configuration) as api_client:
                            line_bot_api = MessagingApi(api_client)
                            line_bot_api.reply_message_with_http_info(
                                ReplyMessageRequest(
                                    reply_token=event.reply_token,
                                    messages=[FlexMessage(alt_text="ÈõÜÂêàË®≠ÂÆö", contents=FlexContainer.from_dict(flex_message))]
                                )
                            )
                    except Exception as e:
                        # ÁôºÁîüÈåØË™§ÊôÇÁöÑËôïÁêÜ
                        logger.error(f"TourClock Ë®≠ÂÆöÈåØË™§: {str(e)}")
                        flex_message = create_flex_message(
                            "meeting_success",
                            meeting_time=meeting_time,
                            meeting_location=meeting_location,
                            is_success=False
                        )
                        
                        with ApiClient(configuration) as api_client:
                            line_bot_api = MessagingApi(api_client)
                            line_bot_api.reply_message_with_http_info(
                                ReplyMessageRequest(
                                    reply_token=event.reply_token,
                                    messages=[FlexMessage(alt_text="ÈõÜÂêàË®≠ÂÆö", contents=FlexContainer.from_dict(flex_message))]
                                )
                            )
                else:
                    # Â¶ÇÊûúÊ≤íÊúâÊâæÂà∞ÊôÇÈñìÊàñÂú∞ÈªûÔºåÊèê‰æõ‰ΩøÁî®Ë™™Êòé
                    flex_message = create_flex_message(
                        "help"
                    )
                    
                    with ApiClient(configuration) as api_client:
                        line_bot_api = MessagingApi(api_client)
                        line_bot_api.reply_message_with_http_info(
                            ReplyMessageRequest(
                                reply_token=event.reply_token,
                                messages=[FlexMessage(alt_text="ÈõÜÂêàÂäüËÉΩË™™Êòé", contents=FlexContainer.from_dict(flex_message))]
                            )
                        )
            
            # Â¶ÇÊûúÊ≤íÊúâÂåÖÂê´ÊôÇÈñìÂú∞ÈªûÁöÑÈõÜÂêàË®≠ÂÆöÔºåÂâáÊ™¢Êü•ÂÖ∂‰ªñÂäüËÉΩ
            else:
                # ÂÑ™ÂÖàÊ™¢Êü•ÊòØÂê¶ÁÇ∫Âú∞ÂçÄÊü•Ë©¢
                location, trips = find_location_trips(user_message)
                if location and trips:
                    # ÂâµÂª∫Ë°åÁ®ãÂàóË°® Flex Message
                    flex_message = create_flex_message(
                        "trip_list",
                        location=location,
                        trips=trips
                    )
                    
                    # ÁôºÈÄÅÊ∂àÊÅØ
                    with ApiClient(configuration) as api_client:
                        line_bot_api = MessagingApi(api_client)
                        line_bot_api.reply_message_with_http_info(
                            ReplyMessageRequest(
                                reply_token=event.reply_token,
                                messages=[FlexMessage(alt_text=f"{location} Ë°åÁ®ãÊé®Ëñ¶", contents=FlexContainer.from_dict(flex_message))]
                            )
                        )
                else:
                    # Ê™¢Êü•ÂÖ∂‰ªñÊ®°ÊùøÂåπÈÖç
                    template_config = get_message_template(user_message)
                    
                    if template_config:
                        # Ê†πÊìöÊ®°ÊùøÈÖçÁΩÆÂâµÂª∫ Flex Message
                        if template_config["template"] == "feature":
                            flex_message = create_flex_message(
                                "feature",
                                feature_name=template_config["feature_name"]
                            )
                        elif template_config["template"] == "leaderboard":
                            flex_message = create_flex_message(
                                "leaderboard",
                                rank=template_config["rank"]
                            )
                        elif template_config["template"] == "help":
                            flex_message = create_flex_message("help")
                        
                        # ÁôºÈÄÅÊ∂àÊÅØ
                        with ApiClient(configuration) as api_client:
                            line_bot_api = MessagingApi(api_client)
                            line_bot_api.reply_message_with_http_info(
                                ReplyMessageRequest(
                                    reply_token=event.reply_token,
                                    messages=[FlexMessage(alt_text="ÂäüËÉΩÂõûÊáâ", contents=FlexContainer.from_dict(flex_message))]
                                )
                            )
                    else:
                        # ÈÅáÂà∞‰∏çË™çË≠òÁöÑÊåá‰ª§ÊôÇ‰∏çÂõûÊáâ
                        pass
        except Exception as e:
            logger.error(f"Reply error: {str(e)}")

    @line_handler.add(PostbackEvent)
    def handle_postback(event):
        try:
            postback_data = event.postback.data
            
            # ËôïÁêÜË°åÁ®ãË©≥ÊÉÖÊü•Ë©¢
            if postback_data.startswith("trip_detail:"):
                trip_id = postback_data.split(":")[1]
                trip = find_trip_by_id(trip_id)
                
                if trip:
                    # ÂâµÂª∫Ë°åÁ®ãË©≥ÊÉÖ Flex Message
                    flex_message = create_flex_message(
                        "trip_detail",
                        trip=trip
                    )
                    
                    # ÁôºÈÄÅÊ∂àÊÅØ
                    with ApiClient(configuration) as api_client:
                        line_bot_api = MessagingApi(api_client)
                        line_bot_api.reply_message_with_http_info(
                            ReplyMessageRequest(
                                reply_token=event.reply_token,
                                messages=[FlexMessage(alt_text=f"{trip['title']} Ë©≥Á¥∞Ë°åÁ®ã", contents=FlexContainer.from_dict(flex_message))]
                            )
                        )
                else:
                    logger.error(f"Êâæ‰∏çÂà∞Ë°åÁ®ã ID: {trip_id}")
            
        except Exception as e:
            logger.error(f"Postback error: {str(e)}")

# Vercel ÈúÄË¶ÅÁöÑ app ËÆäÊï∏
# ÈÄôÊòØÈóúÈçµÔºÅVercel ÊúÉËá™ÂãïÂ∞ãÊâæÈÄôÂÄãËÆäÊï∏
if __name__ != "__main__":
    # Âú® Vercel ‰∏äÈÅãË°åÊôÇ
    pass
else:
    # Êú¨Âú∞ÈñãÁôºÊôÇ
    app.run(debug=True)